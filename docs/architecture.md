# Architecture

## 可行性分析

### 需求

- 通过定位搜索附近类似的商家的畅销商品、单价、营销活动；
- 辅助商家上架选品、商品定价、营销策略

### 需求前置条件

- 抓取平台：美团
- 前期聚焦门类：饮品（茶饮&甜品）

### 业务分析

- 此需求属于商家低频需求，只有在开店、活动假日可能才会使用
- 商家 POI 地址一般性都是固定，所以数据可以提前挖掘分析
- 此类数据有时效性，可能有一定频率的更新需求

### 技术要求

- 自动化程度高、服务稳定、数据可信度高
- 系统及时性要求不高（提前预处理，或给出预期时间）
- 工程整体分为数据发现&挖掘、数据清洗&分析、商业包装&可视化；本项目只关注数据发现和挖掘问题

## 技术调研

### 整体策略 & 优缺点对比

1. Web 端
   - 方案：
     1. 基于 Puppeteer 无头浏览器的页面抓取
     2. 基于 Cypress 等端对端测试框架的页面抓取
   - 优点：
     - 请求链路短、系统复杂度低
     - 无头浏览器，机器成本低；一台主机可同时运行多个进程（以 2C4G 为栗子，可以跑 10-15 个）
   - 缺点：
     - 短信验证码需要外部的接码平台介入（接码平台是违法业务）
     - Web 鉴权较严，破解成本高（滚动条、图形验证码）
     - 部分网页使用了 Font 来处理关键字段（name \ price），破解成本高
2. App 端
   - 方案：
     1. Appium 远程控制
     2. Appium 远程控制 + Charles 代理
     3. Appium 远程控制 + Proxyman CLI
   - 优点：
     - 系统稳定性好（会话登录，可以通过远程控制来模拟）
     - 自动化程度高
     - 配合代理可以获得完整数据
   - 缺点：
     - 请求链路较长、系统复杂度高
     - 需要提供额外的物理机器（安卓、iPhone）作为任务执行机器
     - 需要提供额外的物理主机（Mac、Win）作为远程控制端
     - APP UI 不可预测（活动弹窗、广告、引流）

## 工作原理

### 主要阶段

- 省市区信息查询 POI 阶段：该阶段可以一次性获取，阶段性同步（1 次/月-季）
- 地址逆解析阶段
- DOM 抓取、解析、提取数据阶段

### 流程

- POI 数据获取流程：
  开始 ->
  访问美团城市列表页（获取 DOM 内容） ->
  查询城市区域以及子区域（商业 POI） ->
  逆解析兴趣点地理信息 ->
  写入文件（按城市独立一份文件） ->
  结束
- 地址解析流程：
  开始 ->
  结束
- 店铺&商品数据获取流程：
  开始 ->
  输入省市区、品类 ->
  查询县区内兴趣点 ->
  逆解析兴趣点地理信息 ->
  压入队列 ->
  进入美团 H5 页面 ->
  配置定位 ->
  抓取店铺数据 & 店铺数据 ->
  结束

## 服务

> 本服务类型为脚本服务，仅一个 Node 服务且在执行任务时运行
> 内置： Web Wrapper（puppeteer）、队列（node-queue）、集群（cluster）

### 环境

- Account x N
- Phone Number（可用个人手机替代；接码业务在大陆境内为非法业务）
  - tel: 130xxxxxxxx
- LBS（[lbs.baidu.com](https://lbs.baidu.com/)）
  - appId: xxxxxxxx
  - appKey: xxxxxxxx
- Host: Linux 2C4G x 1
- Node: 14.18.0+
- Proxy IP x N

## 遗留

1. 本服务不解决数据的重复性问题（重复率在 30% - 60%；估算无数据支撑）；
2. 由于兴趣点的重复以及距离（比如鼓楼区新街口和秦淮区新街口实则一个点位；如鼓楼区新街口和鼓楼区上海路仅隔 600 米）；后期优化方向为过滤店铺编号或者店铺名

### 其他问题

- 合法性问题，在项目的 [README](../README.md) 已经说明
- 多 IP 的网络支撑（需要网络组提供代理服务）
- 接码平台可以提高自动化的完整度
- 服务的稳定性
  - 会话的解决
  - 服务形式（Web 服务？还是工作进程？脚本任务？）

### 后期优化方向

- 任务中断归档、存储、告警
- 任务回溯（Trace）、补发、销毁
- 提供缓存，已经查询的地址和门类，直接走数据查询
- 新增门类（店铺类型）可视化脚本录制

## 名词解释

- 美团城市：一般指地级市、县级市、县；也有部分为景点
- 美团城市区域：一般只行政区县、又是也指某旅游景点
- Street POI：商业兴趣点（通常为一个街道、路、单位、学校、景点），表示一个查询定位地址的最小颗粒；poi 与 address 的区别在于，前者强调社会功能属性，后者是行政区域地址
- 逆解析：指将一个 POI 信息解构为省市区、坐标等信息
- 品类：店铺经营类型，如生鲜、美食、饮品、简餐
